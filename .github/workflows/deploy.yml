name: Backend CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: baequest-server/package-lock.json

      - run: npm ci
        working-directory: baequest-server

      - run: npm test
        working-directory: baequest-server

  build-and-deploy:
    runs-on: ubuntu-latest
    needs: test
    # Only deploy on pushes to main, not on PRs
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./baequest-server
          tags: baequest-backend:latest
          load: true

      - name: Write deploy key
        run: |
          echo "${{ secrets.GC_SSH_KEY }}" > /tmp/deploy_key
          chmod 600 /tmp/deploy_key

      - name: Transfer and deploy image
        run: |
          set +e
          HOST="${{ secrets.GC_SERVER_USER }}@${{ secrets.GC_SERVER_HOST }}"
          SSH="ssh -i /tmp/deploy_key -o StrictHostKeyChecking=no -o BatchMode=yes -o ServerAliveInterval=10"

          # Save image
          docker save baequest-backend:latest -o /tmp/image.tar
          IMG_SIZE=$(ls -lh /tmp/image.tar | awk '{print $5}')
          echo "::notice::Image tarball size: $IMG_SIZE"

          # Test 1: SSH echo (should work â€” baseline)
          RESULT=$($SSH "$HOST" "echo OK" 2>&1)
          echo "::notice::SSH echo test: exit=$? output=$RESULT"

          # Test 2: SSH receiving data FROM remote (10MB)
          RESULT=$($SSH "$HOST" "dd if=/dev/urandom bs=1M count=1 2>/dev/null | wc -c" 2>&1)
          echo "::notice::SSH receive 1MB from remote: exit=$? bytes=$RESULT"

          # Test 3: SSH sending 1 byte TO remote
          RESULT=$(echo "X" | $SSH "$HOST" "wc -c" 2>&1)
          echo "::notice::SSH send 1 byte: exit=$? output=$RESULT"

          # Test 4: SSH sending 1MB TO remote
          RESULT=$(dd if=/dev/urandom bs=1M count=1 2>/dev/null | $SSH "$HOST" "wc -c" 2>&1)
          echo "::notice::SSH send 1MB: exit=$? output=$RESULT"

          # Test 5: stdin redirect with 1MB
          dd if=/dev/urandom bs=1M count=1 of=/tmp/test1mb 2>/dev/null
          RESULT=$($SSH "$HOST" "wc -c" < /tmp/test1mb 2>&1)
          echo "::notice::SSH stdin-redirect 1MB: exit=$? output=$RESULT"

          # Test 6: actual docker load via stdin redirect
          RESULT=$($SSH "$HOST" "docker load" < /tmp/image.tar 2>&1)
          echo "::notice::SSH docker load stdin: exit=$? output=$RESULT"

          # Test 7: SFTP
          RESULT=$(sftp -i /tmp/deploy_key -o StrictHostKeyChecking=no -o BatchMode=yes "$HOST" <<< "put /tmp/image.tar /tmp/backend.tar" 2>&1)
          echo "::notice::SFTP put: exit=$? output=$RESULT"

          # If SFTP worked, try docker load from file
          if [ -n "$RESULT" ] && echo "$RESULT" | grep -qi "error\|fail" ; then
            echo "::error::SFTP failed: $RESULT"
          else
            RESULT=$($SSH "$HOST" "docker load -i /tmp/backend.tar 2>&1 && rm -f /tmp/backend.tar" 2>&1)
            echo "::notice::docker load from SFTP file: exit=$? output=$RESULT"
          fi

          rm -f /tmp/image.tar /tmp/test1mb

      - name: Cleanup
        if: always()
        run: rm -f /tmp/deploy_key
