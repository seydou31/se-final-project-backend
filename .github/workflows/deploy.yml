name: Backend CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: baequest-server/package-lock.json

      - run: npm ci
        working-directory: baequest-server

      - run: npm test
        working-directory: baequest-server

  build-and-deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./baequest-server
          tags: baequest-backend:latest
          load: true

      - name: Save image to tarball
        run: docker save baequest-backend:latest -o image.tar

      - name: Upload image as release asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          TAG="deploy-${{ github.sha }}"
          RELEASE=$(curl -sX POST \
            "https://api.github.com/repos/${{ github.repository }}/releases" \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"tag_name\":\"$TAG\",\"name\":\"deploy\"}")
          echo "Release response: $RELEASE"
          RELEASE_ID=$(echo "$RELEASE" | node -e "const d=require('fs').readFileSync(0,'utf8');const id=JSON.parse(d).id;if(!id){console.error('Failed to create release');process.exit(1)}console.log(id)")
          echo "Release ID: $RELEASE_ID"
          UPLOAD_STATUS=$(curl -s -o /dev/null -w '%{http_code}' -X POST \
            "https://uploads.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID/assets?name=image.tar" \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @image.tar)
          echo "Upload HTTP status: $UPLOAD_STATUS"
          [ "$UPLOAD_STATUS" = "201" ] || { echo "ERROR: Asset upload failed with status $UPLOAD_STATUS"; exit 1; }
          echo "RELEASE_ID=$RELEASE_ID" >> $GITHUB_ENV
          echo "RELEASE_TAG=$TAG" >> $GITHUB_ENV

      - name: Deploy via SSH pull
        run: |
          echo "${{ secrets.GC_SSH_KEY }}" > /tmp/deploy_key
          chmod 600 /tmp/deploy_key
          HOST="${{ secrets.GC_SERVER_USER }}@${{ secrets.GC_SERVER_HOST }}"
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/$RELEASE_TAG/image.tar"

          {
            echo "=== Pre-flight ==="
            echo "Host: $HOST"
            echo "RELEASE_TAG: $RELEASE_TAG"
            echo "Download URL: $DOWNLOAD_URL"
            ssh-keygen -l -f /tmp/deploy_key
            echo "Local asset check: $(curl -s -o /dev/null -w '%{http_code}' -L "$DOWNLOAD_URL")"

            echo "=== SSH connectivity test ==="
            ssh -v -i /tmp/deploy_key -o StrictHostKeyChecking=no -o BatchMode=yes \
              -o ConnectTimeout=10 "$HOST" \
              "echo SSH_OK; uname -a; df -h /; docker ps -a; echo ENV_FILE_EXISTS=\$(test -f /home/badiakaseydou/se-final-project-backend/baequest-server/.env && echo yes || echo no)" 2>&1

            echo "=== Deploy ==="
            ssh -i /tmp/deploy_key -o StrictHostKeyChecking=no -o BatchMode=yes \
              -o ConnectTimeout=10 "$HOST" \
              "echo Stopping old container; \
               docker stop baequest-backend 2>/dev/null || true; \
               docker rm baequest-backend 2>/dev/null || true; \
               echo Freeing disk space; \
               journalctl --vacuum-size=50M 2>/dev/null || true; \
               docker system prune -af 2>/dev/null; \
               df -h /; \
               echo Streaming and loading image; \
               curl -sL '$DOWNLOAD_URL' | docker load; \
               LOAD_EXIT=\$?; \
               echo LOAD_EXIT=\$LOAD_EXIT; \
               if [ \$LOAD_EXIT -ne 0 ]; then echo LOAD_FAILED; df -h /; exit 1; fi; \
               fuser -k 3001/tcp 2>/dev/null || true; \
               echo Starting container; \
               docker run -d --name baequest-backend --network host --restart=unless-stopped \
                 --env-file /home/badiakaseydou/se-final-project-backend/baequest-server/.env \
                 -v /home/badiakaseydou/se-final-project-backend/baequest-server/uploads:/app/uploads \
                 -v /home/badiakaseydou/se-final-project-backend/baequest-server/logs:/app/logs \
                 baequest-backend:latest; \
               echo RUN_EXIT=\$?; \
               docker ps" 2>&1

            echo "=== SSH exit code: \$? ==="
          } | tee /tmp/deploy_debug.log

          rm -f /tmp/deploy_key

          if grep -q "RUN_EXIT=0" /tmp/deploy_debug.log; then
            echo "Deploy succeeded"
          else
            echo "Deploy failed - check artifact for details"
            exit 1
          fi

      - name: Upload deploy debug log
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: deploy-debug-log
          path: /tmp/deploy_debug.log

      - name: Cleanup release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "$RELEASE_ID" ]; then
            curl -sX DELETE \
              "https://api.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID" \
              -H "Authorization: token $GITHUB_TOKEN"
            curl -sX DELETE \
              "https://api.github.com/repos/${{ github.repository }}/git/refs/tags/$RELEASE_TAG" \
              -H "Authorization: token $GITHUB_TOKEN"
          fi
