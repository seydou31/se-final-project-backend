name: Backend CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: baequest-server/package-lock.json

      - run: npm ci
        working-directory: baequest-server

      - run: npm test
        working-directory: baequest-server

  build-and-deploy:
    runs-on: ubuntu-latest
    needs: test
    # Only deploy on pushes to main, not on PRs
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./baequest-server
          tags: baequest-backend:latest
          load: true

      - name: Save image to tarball
        run: docker save baequest-backend:latest -o image.tar

      - name: Upload image as release asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="deploy-${{ github.sha }}"
          # Create a release
          RELEASE=$(curl -sX POST \
            "https://api.github.com/repos/${{ github.repository }}/releases" \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"tag_name\":\"$TAG\",\"name\":\"deploy\"}")
          RELEASE_ID=$(echo "$RELEASE" | node -e "const d=require('fs').readFileSync(0,'utf8');console.log(JSON.parse(d).id)")
          echo "Release ID: $RELEASE_ID"
          # Upload the tarball
          curl -sX POST \
            "https://uploads.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID/assets?name=image.tar" \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @image.tar
          echo "RELEASE_ID=$RELEASE_ID" >> $GITHUB_ENV
          echo "RELEASE_TAG=$TAG" >> $GITHUB_ENV

      - name: Deploy via SSH pull
        run: |
          echo "${{ secrets.GC_SSH_KEY }}" > /tmp/deploy_key
          chmod 600 /tmp/deploy_key
          HOST="${{ secrets.GC_SERVER_USER }}@${{ secrets.GC_SERVER_HOST }}"
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/$RELEASE_TAG/image.tar"

          # Diagnostics
          echo "=== DIAG: Runner external IP ==="
          curl -s https://api.ipify.org || echo "ipify failed"
          echo ""
          echo "=== DIAG: SSH target host ==="
          echo "$HOST"
          echo "=== DIAG: Key type ==="
          head -1 /tmp/deploy_key
          ssh-keygen -l -f /tmp/deploy_key 2>&1 || echo "keygen -l failed"
          echo "=== DIAG: TCP connectivity test ==="
          timeout 5 bash -c "echo >/dev/tcp/${{ secrets.GC_SERVER_HOST }}/22" 2>&1 && echo "TCP:22 OK" || echo "TCP:22 FAILED"
          echo "=== END DIAG ==="

          # First attempt with verbose SSH to capture the error
          echo "Attempt 1 (verbose)..."
          ssh -v -i /tmp/deploy_key -o StrictHostKeyChecking=no -o BatchMode=yes \
            -o ConnectTimeout=10 "$HOST" \
            "curl -sL '$DOWNLOAD_URL' | docker load && \
             (docker stop baequest-backend || true) && \
             (docker rm baequest-backend || true) && \
             docker run -d --name baequest-backend -p 3001:3001 --restart=unless-stopped \
               --env-file /home/badiakaseydou/se-final-project-backend/baequest-server/.env \
               -v /home/badiakaseydou/se-final-project-backend/baequest-server/uploads:/app/uploads \
               -v /home/badiakaseydou/se-final-project-backend/baequest-server/logs:/app/logs \
               baequest-backend:latest" 2>&1 && { echo "Deploy succeeded on attempt 1"; rm -f /tmp/deploy_key; exit 0; }

          # Retry 4 more times non-verbose
          DEPLOYED=false
          for attempt in 2 3 4 5; do
            echo "Attempt $attempt..."
            sleep 5
            if ssh -i /tmp/deploy_key -o StrictHostKeyChecking=no -o BatchMode=yes \
              -o ConnectTimeout=10 "$HOST" \
              "curl -sL '$DOWNLOAD_URL' | docker load && \
               (docker stop baequest-backend || true) && \
               (docker rm baequest-backend || true) && \
               docker run -d --name baequest-backend -p 3001:3001 --restart=unless-stopped \
                 --env-file /home/badiakaseydou/se-final-project-backend/baequest-server/.env \
                 -v /home/badiakaseydou/se-final-project-backend/baequest-server/uploads:/app/uploads \
                 -v /home/badiakaseydou/se-final-project-backend/baequest-server/logs:/app/logs \
                 baequest-backend:latest" 2>&1; then
              echo "Deploy succeeded on attempt $attempt"
              DEPLOYED=true
              break
            fi
            echo "SSH failed attempt $attempt"
          done

          rm -f /tmp/deploy_key
          [ "$DEPLOYED" = true ] || exit 1

      - name: Post SSH diagnostics as issue
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "${{ secrets.GC_SSH_KEY }}" > /tmp/deploy_key_diag
          chmod 600 /tmp/deploy_key_diag
          RUNNER_IP=$(curl -s https://api.ipify.org)
          KEY_TYPE=$(head -1 /tmp/deploy_key_diag)
          KEY_FP=$(ssh-keygen -l -f /tmp/deploy_key_diag 2>&1)
          KEY_LINES=$(wc -l < /tmp/deploy_key_diag)
          TCP_TEST=$(timeout 3 bash -c "echo >/dev/tcp/${{ secrets.GC_SERVER_HOST }}/22" 2>&1 && echo "TCP OK" || echo "TCP FAIL")
          SSH_TEST=$(ssh -v -i /tmp/deploy_key_diag -o StrictHostKeyChecking=no -o BatchMode=yes -o ConnectTimeout=5 ${{ secrets.GC_SERVER_USER }}@${{ secrets.GC_SERVER_HOST }} echo "auth ok" 2>&1)
          rm -f /tmp/deploy_key_diag
          BODY="## SSH Deploy Diagnostics (run ${{ github.run_number }})\n\n- **Runner IP:** ${RUNNER_IP}\n- **Target:** ${{ secrets.GC_SERVER_USER }}@${{ secrets.GC_SERVER_HOST }}\n- **Key first line:** ${KEY_TYPE}\n- **Key fingerprint:** ${KEY_FP}\n- **Key line count:** ${KEY_LINES}\n- **TCP :22 test:** ${TCP_TEST}\n- **SSH verbose output:**\n\`\`\`\n${SSH_TEST}\n\`\`\`\n"
          curl -sX POST \
            "https://api.github.com/repos/${{ github.repository }}/issues" \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"title\":\"[DEBUG] SSH deploy failure - run #${{ github.run_number }}\",\"body\":\"$(echo -e "$BODY" | sed 's/"/\\"/g')\"}"

      - name: Cleanup release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "$RELEASE_ID" ]; then
            curl -sX DELETE \
              "https://api.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID" \
              -H "Authorization: token $GITHUB_TOKEN"
            curl -sX DELETE \
              "https://api.github.com/repos/${{ github.repository }}/git/refs/tags/$RELEASE_TAG" \
              -H "Authorization: token $GITHUB_TOKEN"
          fi
