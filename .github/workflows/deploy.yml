name: Backend CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: baequest-server/package-lock.json

      - run: npm ci
        working-directory: baequest-server

      - run: npm test
        working-directory: baequest-server

  build-and-deploy:
    runs-on: ubuntu-latest
    needs: test
    # Only deploy on pushes to main, not on PRs
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./baequest-server
          tags: baequest-backend:latest
          load: true

      - name: Write deploy key
        run: |
          echo "${{ secrets.GC_SSH_KEY }}" > /tmp/deploy_key
          chmod 600 /tmp/deploy_key

      - name: Transfer and deploy image
        run: |
          HOST="${{ secrets.GC_SERVER_USER }}@${{ secrets.GC_SERVER_HOST }}"

          # Save image to file
          docker save baequest-backend:latest -o /tmp/image.tar
          ls -lh /tmp/image.tar

          # Start HTTP server serving /tmp on port 8888
          cd /tmp && python3 -m http.server 8888 &
          HTTP_PID=$!
          sleep 1

          # SSH with reverse tunnel: remote port 8888 maps to local 8888
          # VM curls localhost:8888/image.tar through the tunnel, pipes to docker load
          ssh -i /tmp/deploy_key -o StrictHostKeyChecking=no -o BatchMode=yes \
            -R 8888:127.0.0.1:8888 "$HOST" \
            "curl -s http://127.0.0.1:8888/image.tar | docker load && \
             (docker stop baequest-backend || true) && \
             (docker rm baequest-backend || true) && \
             docker run -d --name baequest-backend -p 3001:3001 --restart=unless-stopped \
               --env-file /home/badiakaseydou/se-final-project-backend/baequest-server/.env \
               -v /home/badiakaseydou/se-final-project-backend/baequest-server/uploads:/app/uploads \
               -v /home/badiakaseydou/se-final-project-backend/baequest-server/logs:/app/logs \
               baequest-backend:latest"
          SSH_EXIT=$?

          kill $HTTP_PID 2>/dev/null
          rm -f /tmp/image.tar

          exit $SSH_EXIT

      - name: Cleanup
        if: always()
        run: rm -f /tmp/deploy_key
