name: Backend CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: baequest-server/package-lock.json

      - run: npm ci
        working-directory: baequest-server

      - run: npm test
        working-directory: baequest-server

  build-and-deploy:
    runs-on: ubuntu-latest
    needs: test
    # Only deploy on pushes to main, not on PRs
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./baequest-server
          tags: baequest-backend:latest
          load: true

      - name: Write deploy key
        run: |
          echo "${{ secrets.GC_SSH_KEY }}" > /tmp/deploy_key
          chmod 600 /tmp/deploy_key

      - name: Transfer and deploy image
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REPO: ${{ github.repository }}
        run: |
          set +e
          HOST="${{ secrets.GC_SERVER_USER }}@${{ secrets.GC_SERVER_HOST }}"
          SSH="ssh -i /tmp/deploy_key -o StrictHostKeyChecking=no -o BatchMode=yes"
          LOG=""
          log() { LOG="${LOG}${1}\n"; echo "$1"; }

          # Save image
          docker save baequest-backend:latest -o /tmp/image.tar
          log "Image size: $(ls -lh /tmp/image.tar | awk '{print $5}')"

          # Test 1: SSH echo
          OUT=$($SSH "$HOST" "echo OK" 2>&1); RC=$?
          log "T1 ssh-echo: exit=$RC out=$OUT"

          # Test 2: SSH key fingerprint
          OUT=$(ssh-keygen -l -f /tmp/deploy_key 2>&1); RC=$?
          log "T2 key-fp: exit=$RC out=$OUT"

          # Test 3: SSH with stdin redirect
          OUT=$($SSH "$HOST" "cat | wc -c" < /tmp/image.tar 2>&1); RC=$?
          log "T3 stdin-redirect: exit=$RC bytes=$OUT"

          # Test 4: Pipe
          OUT=$(cat /tmp/image.tar | $SSH "$HOST" "cat | wc -c" 2>&1); RC=$?
          log "T4 pipe: exit=$RC bytes=$OUT"

          # Test 5: native scp
          scp -i /tmp/deploy_key -o StrictHostKeyChecking=no -o BatchMode=yes /tmp/image.tar "$HOST":/tmp/backend.tar 2>/tmp/scp_err.txt; RC=$?
          log "T5 native-scp: exit=$RC err=$(cat /tmp/scp_err.txt)"

          # Test 6: sftp
          OUT=$(echo "put /tmp/image.tar /tmp/backend.tar" | sftp -i /tmp/deploy_key -o StrictHostKeyChecking=no -o BatchMode=yes "$HOST" 2>&1); RC=$?
          log "T6 sftp: exit=$RC out=$OUT"

          # Test 7: sshd config from remote
          OUT=$($SSH "$HOST" "cat /etc/ssh/sshd_config 2>/dev/null || echo no-sshd-config" 2>&1); RC=$?
          log "T7 sshd-config: exit=$RC"
          log "$OUT"

          # Post results as a commit comment
          ESCAPED=$(printf '%s' "$LOG" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
          curl -sX POST \
            "https://api.github.com/repos/$GITHUB_REPO/commits/$GITHUB_SHA/comments" \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"body\":\"SSH Diagnostic:\\n\\n\`\`\`\\n${ESCAPED}\\n\`\`\`\"}"

          # If any transfer worked, do the deploy
          if $SSH "$HOST" "test -f /tmp/backend.tar"; then
            log "File exists on remote, deploying..."
            $SSH "$HOST" "docker load -i /tmp/backend.tar && (docker stop baequest-backend || true) && (docker rm baequest-backend || true) && docker run -d --name baequest-backend -p 3001:3001 --restart=unless-stopped --env-file /home/badiakaseydou/se-final-project-backend/baequest-server/.env -v /home/badiakaseydou/se-final-project-backend/baequest-server/uploads:/app/uploads -v /home/badiakaseydou/se-final-project-backend/baequest-server/logs:/app/logs baequest-backend:latest && rm -f /tmp/backend.tar"
          fi

          rm -f /tmp/image.tar /tmp/scp_err.txt

      - name: Cleanup
        if: always()
        run: rm -f /tmp/deploy_key
