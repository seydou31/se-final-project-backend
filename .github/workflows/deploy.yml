name: Backend CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: baequest-server/package-lock.json

      - run: npm ci
        working-directory: baequest-server

      - run: npm test
        working-directory: baequest-server

  build-and-deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./baequest-server
          tags: baequest-backend:latest
          load: true

      - name: Save image to tarball
        run: docker save baequest-backend:latest -o image.tar

      - name: Upload image as release asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          TAG="deploy-${{ github.sha }}"
          RELEASE=$(curl -sX POST \
            "https://api.github.com/repos/${{ github.repository }}/releases" \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"tag_name\":\"$TAG\",\"name\":\"deploy\"}")
          echo "Release response: $RELEASE"
          RELEASE_ID=$(echo "$RELEASE" | node -e "const d=require('fs').readFileSync(0,'utf8');const id=JSON.parse(d).id;if(!id){console.error('Failed to create release');process.exit(1)}console.log(id)")
          echo "Release ID: $RELEASE_ID"
          UPLOAD_STATUS=$(curl -s -o /dev/null -w '%{http_code}' -X POST \
            "https://uploads.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID/assets?name=image.tar" \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @image.tar)
          echo "Upload HTTP status: $UPLOAD_STATUS"
          [ "$UPLOAD_STATUS" = "201" ] || { echo "ERROR: Asset upload failed with status $UPLOAD_STATUS"; exit 1; }
          echo "RELEASE_ID=$RELEASE_ID" >> $GITHUB_ENV
          echo "RELEASE_TAG=$TAG" >> $GITHUB_ENV

      - name: Deploy via SSH pull
        run: |
          echo "${{ secrets.GC_SSH_KEY }}" > /tmp/deploy_key
          chmod 600 /tmp/deploy_key
          HOST="${{ secrets.GC_SERVER_USER }}@${{ secrets.GC_SERVER_HOST }}"
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/$RELEASE_TAG/image.tar"

          # Diagnostics
          echo "=== Deploy diagnostics ==="
          echo "Host: $HOST"
          echo "RELEASE_TAG: $RELEASE_TAG"
          echo "Download URL: $DOWNLOAD_URL"
          ssh-keygen -l -f /tmp/deploy_key 2>&1 || echo "Key validation failed"
          echo "Asset reachable? $(curl -s -o /dev/null -w '%{http_code}' -L "$DOWNLOAD_URL")"
          echo "=== SSH connectivity test ==="
          ssh -v -i /tmp/deploy_key -o StrictHostKeyChecking=no -o BatchMode=yes \
            -o ConnectTimeout=10 "$HOST" "echo SSH_OK" 2>&1 || echo "SSH connectivity test FAILED"
          echo "=== Starting deploy ==="

          DEPLOYED=false
          for attempt in 1 2 3 4 5; do
            echo "Attempt $attempt..."
            if ssh -i /tmp/deploy_key -o StrictHostKeyChecking=no -o BatchMode=yes \
              -o ConnectTimeout=10 "$HOST" \
              "pkill -f 'node /home' || true; \
               curl -sL '$DOWNLOAD_URL' | docker load && \
               (docker stop baequest-backend || true) && \
               (docker rm baequest-backend || true) && \
               docker run -d --name baequest-backend --network host --restart=unless-stopped \
                 --env-file /home/badiakaseydou/se-final-project-backend/baequest-server/.env \
                 -v /home/badiakaseydou/se-final-project-backend/baequest-server/uploads:/app/uploads \
                 -v /home/badiakaseydou/se-final-project-backend/baequest-server/logs:/app/logs \
                 baequest-backend:latest" 2>&1; then
              echo "Deploy succeeded on attempt $attempt"
              DEPLOYED=true
              break
            fi
            echo "SSH failed, waiting 5s before retry..."
            sleep 5
          done

          rm -f /tmp/deploy_key
          [ "$DEPLOYED" = true ] || exit 1

      - name: Cleanup release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "$RELEASE_ID" ]; then
            curl -sX DELETE \
              "https://api.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID" \
              -H "Authorization: token $GITHUB_TOKEN"
            curl -sX DELETE \
              "https://api.github.com/repos/${{ github.repository }}/git/refs/tags/$RELEASE_TAG" \
              -H "Authorization: token $GITHUB_TOKEN"
          fi
